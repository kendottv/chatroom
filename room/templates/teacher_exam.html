{% extends 'base.html' %}
{% block title %}計算機概論 - 出題{% endblock %}

{% block content %}
    {% load static %}
    <!-- 引入 Quill CSS -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">

    <!-- 自訂樣式 -->
    <link rel="stylesheet" href="{% static 'css/teacher_exam.css' %}">

    <div class="content">
        <!-- 標籤頁導航 -->
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('create-question')">新增題目</button>
            <button class="tab-button" onclick="switchTab('question-bank')">題目庫</button>
            <button class="tab-button" onclick="switchTab('create-exam')">創建考試</button>
        </div>

        <!-- 新增題目標籤頁 -->
        <div id="create-question" class="tab-content active">
            <h3>新增題目</h3>
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
            <form method="post" action="{% url 'room:teacher_exam' %}" enctype="multipart/form-data">
                {% csrf_token %}
                {% if question_to_edit %}
                    <input type="hidden" name="question_id" value="{{ question_to_edit.id }}" class="col-12">
                {% endif %}
                
                <div class="form-group col-md-6">
                    <label for="title" class="form-label">題目標題：</label>
                    <input type="text" name="title" value="{{ question_to_edit.title|default:'' }}" class="form-control" required>
                </div>
                
                <div class="form-group col-md-6">
                    <label for="question_type" class="form-label">題型：</label>
                    <select name="question_type" id="question_type" class="form-select" onchange="updateForm()">
                        {% for key, value in question_types.items %}
                            <option value="{{ key }}" {% if question_to_edit and question_to_edit.question_type == key %}selected{% endif %}>{{ value }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group col-12">
                    <label for="question_text" class="form-label">題目內容：</label>
                    <div id="question_editor">
                        <div id="editor-container">{% if question_to_edit %}{{ question_to_edit.content|safe }}{% else %}<p>請輸入題目內容</p>{% endif %}</div>
                        <input type="hidden" name="question_text" id="hidden_question">
                    </div>
                </div>
                
                <!-- 選項部分 -->
                <div class="options col-12" id="options_container" style="display: none;">
                    <h4>選項：</h4>
                    {% for i in "1234" %}
                        <div class="form-group option-input-group">
                            <span class="answer-selector">
                                <input type="radio" name="correct_option" value="{{ forloop.counter0 }}" 
                                    {% if question_to_edit and question_to_edit.correct_option_indices == forloop.counter0|stringformat:"s" %}checked{% endif %} 
                                    class="sc-answer">
                                <input type="checkbox" name="correct_options" value="{{ forloop.counter0 }}" 
                                    {% if question_to_edit and question_to_edit.correct_answer_list and forloop.counter0|stringformat:"s" in question_to_edit.correct_answer_list %}checked{% endif %}  
                                    class="mcq-answer" style="display: none;">
                                <label>正確答案</label>
                            </span>
                            <input type="text" name="option_{{ forloop.counter }}" 
                                value="{% if question_to_edit.options %}{% if forloop.counter == 1 %}{{ question_to_edit.options.0|default:'' }}{% elif forloop.counter == 2 %}{{ question_to_edit.options.1|default:'' }}{% elif forloop.counter == 3 %}{{ question_to_edit.options.2|default:'' }}{% elif forloop.counter == 4 %}{{ question_to_edit.options.3|default:'' }}{% endif %}{% endif %}" 
                                class="form-control option-input" 
                                placeholder="選項 {{ forloop.counter }}" 
                                {% if not question_to_edit %}disabled{% elif question_to_edit.question_type == "sc" or question_to_edit.question_type == "mcq" %}{% else %}disabled{% endif %}>
                        </div>
                    {% endfor %}
                </div>
                
                <!-- 真假題答案 -->
                <div class="options col-12" id="true_false_container" style="display: none;">
                    <h4>答案：</h4>
                    <div class="form-group">
                        <div class="form-check">
                            <input type="radio" name="correct_answer" value="true" {% if question_to_edit and question_to_edit.is_correct == True %}checked{% endif %} class="form-check-input" id="answer_true">
                            <label class="form-check-label" for="answer_true">True</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="form-check">
                            <input type="radio" name="correct_answer" value="false" {% if question_to_edit and question_to_edit.is_correct == False %}checked{% endif %} class="form-check-input" id="answer_false">
                            <label class="form-check-label" for="answer_false">False</label>
                        </div>
                    </div>
                </div>
                
                <!-- 簡答題答案 -->
                <div class="options col-12" id="short_answer_container" style="display: none;">
                    <h4>參考答案（選填）：</h4>
                    <div class="form-group">
                        <textarea name="correct_answer" class="form-control" rows="3" placeholder="請輸入參考答案（可選）">{% if question_to_edit and question_to_edit.correct_option_indices %}{{ question_to_edit.correct_option_indices }}{% endif %}</textarea>
                    </div>
                </div>
                
                <div class="form-group col-md-6">
                    <label for="max_attempts" class="form-label">最大嘗試次數：</label>
                    <input type="number" name="max_attempts" value="{{ question_to_edit.max_attempts|default:1 }}" class="form-control" min="1" required>
                </div>
                
                <div class="form-group col-md-6">
                    <label for="points" class="form-label">配分：</label>
                    <input type="number" name="points" value="{{ question_to_edit.points|default:10 }}" class="form-control" min="0" max="100" required>
                </div>
                
                <div class="form-group col-md-6">
                    <label for="ai_limit" class="form-label">AI 問答次數限制：</label>
                    <input type="number" name="ai_limit" value="{{ question_to_edit.ai_limit|default:1 }}" class="form-control" min="1" required>
                </div>
                
                <div class="form-group col-12">
                    <label for="image" class="form-label">上傳圖片：</label>
                    <input type="file" name="image" accept="image/*" class="form-control">
                    {% if question_to_edit and question_to_edit.image %}
                        <p class="mt-2">當前圖片: <img src="{{ question_to_edit.image.url }}" width="100"></p>
                    {% endif %}
                </div>
                
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        {% if question_to_edit %}更新題目{% else %}儲存題目{% endif %}
                    </button>
                </div>
            </form>
        </div>

        <!-- 題目庫標籤頁 -->
        <div id="question-bank" class="tab-content">
            <div class="question-bank">
                <div class="row mb-3">
                    <div class="col">
                        <h3>題目庫 ({{ all_questions.count }} 題)</h3>
                    </div>
                    <div class="col-auto">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-primary" onclick="selectAll()">全選</button>
                            <button type="button" class="btn btn-secondary" onclick="clearSelection()">清除選擇</button>
                            <button type="button" class="btn btn-warning" onclick="showSelectedQuestions()">查看已選題目 (<span id="selected-count">0</span>)</button>
                        </div>
                    </div>
                </div>

                <!-- 刪除題目表單 -->
                <form method="post" action="{% url 'room:teacher_exam' %}" id="delete-form">
                    {% csrf_token %}
                    <input type="hidden" name="delete_question" value="1">
                    
                    <div style="margin-bottom: 20px;">
                        <button type="submit" class="btn btn-danger" onclick="return confirmDelete()">刪除選定題目</button>
                    </div>

                    <div id="selected-summary" class="selected-questions" style="display: none;">
                        <h4>已選題目</h4>
                        <div id="selected-list"></div>
                        <div class="selected-count">
                            總計：<span id="total-questions">0</span> 題，<span id="total-points">0</span> 分，AI 問答次數限制：<span id="total-ai-limit">0</span> 次
                        </div>
                    </div>

                    {% for question in all_questions %}
                        <div class="question-item" id="question-{{ question.id }}" 
                            data-id="{{ question.id }}" 
                            data-title="{{ question.title }}" 
                            data-type="{{ question.question_type }}" 
                            data-points="{{ question.points }}"
                            data-ai-limit="{{ question.ai_limit|default:1 }}">
                            <input type="checkbox" name="delete_questions" value="{{ question.id }}" class="form-check-input question-checkbox" onchange="updateSelection()">
                            
                            <div class="row">
                                <div class="col">
                                    <div class="question-header">
                                        <span class="badge bg-primary question-type-badge">
                                            {% if question.question_type == "sc" %}單選題
                                            {% elif question.question_type == "mcq" %}多選題
                                            {% elif question.question_type == "tf" %}是非題
                                            {% elif question.question_type == "sa" %}簡答題
                                            {% else %}{{ question.question_type }}{% endif %}
                                        </span>
                                        <span class="badge bg-secondary points-badge">{{ question.points }} 分</span>
                                        <span class="badge bg-info ai-limit-badge">AI 限制: {{ question.ai_limit|default:'1' }} 次</span>
                                    </div>
                                    <p class="mt-2"><strong>{{ question.title }}</strong></p>
                                    
                                    <!-- 顯示題目內容 -->
                                    <div class="question-content">
                                        {{ question.content|safe }}
                                    </div>
                                    
                                    {% if question.options and question.question_type == "sc" or question.options and question.question_type == "mcq" %}
                                        <div class="mt-2" style="font-size: 14px; color: #666;">
                                            <strong>選項:</strong>
                                            {% for option in question.options %}
                                                <div class="ms-2">{{ forloop.counter }}. {{ option }}</div>
                                            {% endfor %}
                                        </div>
                                        <div class="mt-2" style="font-size: 14px; color: #28a745;">
                                            <strong>正確答案:</strong>
                                            {% if question.question_type == "sc" %}
                                                選項 {{ question.correct_option_indices|add:1 }}
                                            {% elif question.question_type == "mcq" %}
                                                {% if question.correct_option_indices_list %}
                                                    {% for idx in question.correct_option_indices_list %}
                                                        選項 {{ idx|add:1 }}{% if not forloop.last %}, {% endif %}
                                                    {% endfor %}
                                                {% else %}
                                                    {{ question.correct_option_indices }}
                                                {% endif %}
                                            {% endif %} (Debug: {{ question.correct_option_indices|default:'None' }})
                                        </div>
                                    {% elif question.question_type == "tf" %}
                                        <div class="mt-2" style="font-size: 14px; color: #28a745;">
                                            <strong>答案:</strong> {{ question.is_correct|yesno:"True,False" }} (Debug: {{ question.is_correct|default:'None' }})
                                        </div>
                                    {% elif question.question_type == "sa" %}
                                        {% if question.correct_option_indices %}
                                            <div class="mt-2" style="font-size: 14px; color: #28a745;">
                                                <strong>參考答案:</strong> {{ question.correct_option_indices }}
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                    
                                    <div class="mt-2" style="font-size: 12px; color: #999;">
                                        創建時間: {{ question.created_at|date:"Y-m-d H:i" }}
                                        <a href="?edit={{ question.id }}" class="ms-2 text-primary">編輯</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <p class="text-muted">目前沒有題目。請先新增題目。</p>
                    {% endfor %}
                </form>
            </div>
        </div>

        <!-- 創建考試標籤頁 -->
        <div id="create-exam" class="tab-content">
            <h3>創建考試</h3>
            <form method="post" action="{% url 'room:teacher_exam' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="action" value="create_exam">
                
                <div class="form-group col-md-6">
                    <label for="exam_title" class="form-label">考試名稱：</label>
                    <input type="text" name="exam_title" class="form-control" required>
                </div>
                
                <div class="form-group col-md-6">
                    <label for="exam_description" class="form-label">考試說明：</label>
                    <textarea name="exam_description" rows="3" class="form-control"></textarea>
                </div>
                
                <div class="form-group col-md-4">
                    <label for="publish_time" class="form-label">發佈時間：</label>
                    <input type="datetime-local" name="publish_time" class="form-control" required>
                </div>
                
                <div class="form-group col-md-4">
                    <label for="start_time" class="form-label">開始時間：</label>
                    <input type="datetime-local" name="start_time" class="form-control" required>
                </div>
                
                <div class="form-group col-md-4">
                    <label for="end_time" class="form-label">截止時間：</label>
                    <input type="datetime-local" name="end_time" class="form-control" required>
                </div>
                
                <div class="form-group col-12">
                    <label for="duration_minutes" class="form-label">考試時長（分鐘）：</label>
                    <input type="number" name="duration_minutes" value="60" class="form-control" min="5" max="300" required>
                </div>

                <div class="form-group col-12">
                    <label class="form-label">考試題目：</label>
                    <div id="exam-questions-summary" style="border: 1px solid #ddd; padding: 15px; border-radius: 10px; background: #f8f9fa; min-height: 100px;">
                        <p style="color: #666;">請先到「題目庫」標籤頁選擇要加入考試的題目</p>
                        <p>總計：<span id="total-questions-exam">0</span> 題，<span id="total-points-exam">0</span> 分，AI 問答次數限制：<span id="total-ai-limit-exam">0</span> 次</p>
                    </div>
                </div>
                
                <input type="hidden" name="selected_questions" id="selected_questions_input">
                
                <div class="col-12">
                    <button type="submit" class="btn btn-primary" id="create-exam-btn" disabled>創建考試</button>
                    <button type="button" class="btn btn-secondary" onclick="switchTab('question-bank')">選擇題目</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 引入 Quill JS -->
    <script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>
    <script src="{% static 'js/teacher_exam.js' %}"></script>
{% endblock %}