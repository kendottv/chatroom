<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€ƒè©¦</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/exam.css' %}">
</head>
<body>
    <!-- ç°¡å–®å°èˆªæ¬„ -->
    <nav>
        <div>
            <a href="/" style="margin-right: 20px;">é¦–é </a>
            <a href="/exam/" style="margin-right: 20px;">è€ƒè©¦</a>
        </div>
    </nav>

    <!-- è³‡è¨Šæ¬„ -->
    <div class="info-bar">
        <span>å­¸è™Ÿ: {{ user.student_id }}</span>
        <span>å§“å: {{ user.username }}</span>
        <span>ç­ç´š: {{ user.class_name }}</span>
    </div>

    <!-- è€ƒè©¦å®¹å™¨ -->
    <div class="exam-container">
        <!-- AI å•ç­”å€åŸŸï¼ˆå·¦å´ï¼‰ -->
        <div class="ai-section">
            <h3 class="ai-title">ğŸ¤– AI å•ç­”åŠ©æ‰‹</h3>
            <div class="ai-description">
                å¦‚æœæ‚¨åœ¨è€ƒè©¦éç¨‹ä¸­æœ‰ç–‘å•ï¼Œå¯ä»¥å‘ AI åŠ©æ‰‹æå•ç²å¾—å¹«åŠ©
            </div>
            <textarea id="ai_question" class="ai-input" placeholder="è«‹è¼¸å…¥æ‚¨çš„å•é¡Œï¼Œä¾‹å¦‚ï¼š
â€¢ é€™é“é¡Œç›®çš„é—œéµæ¦‚å¿µæ˜¯ä»€éº¼ï¼Ÿ
â€¢ æˆ‘æ‡‰è©²å¦‚ä½•ç†è§£é€™å€‹å•é¡Œï¼Ÿ
â€¢ èƒ½å¦è§£é‡‹ä¸€ä¸‹ç›¸é—œçŸ¥è­˜é»ï¼Ÿ"></textarea>
            <button onclick="askAI()" class="ai-btn">ğŸ’¬ å‘ AI æå•</button>
            <div id="ai-response" class="ai-response">
                AI å›æ‡‰å°‡é¡¯ç¤ºåœ¨é€™è£¡...
                <br><br>
                ğŸ’¡ <strong>ä½¿ç”¨æç¤ºï¼š</strong>
                <ul style="margin: 10px 0; padding-left: 20px; font-size: 13px;">
                    <li>æå•è¦å…·é«”æ˜ç¢º</li>
                    <li>å¯ä»¥è©¢å•æ¦‚å¿µè§£é‡‹</li>
                    <li>å¯ä»¥è«‹æ±‚è§£é¡Œæ€è·¯</li>
                </ul>
            </div>
        </div>

        <!-- åˆ†éš”ç·š -->
        <div class="divider"></div>

        <!-- è€ƒå·å€åŸŸï¼ˆå³å´ï¼‰ -->
        <div class="exam-paper-section">
            <!-- é¡¯ç¤ºè¨Šæ¯ -->
            {% if messages %}
                <div class="messages">
                    {% for message in messages %}
                        <p class="{{ message.tags }}">{{ message }}</p>
                    {% endfor %}
                </div>
            {% endif %}

            <!-- é™¤éŒ¯è³‡è¨Š -->
            <p>Debug: exam_papers count = {{ exam_papers|length }}</p>
            {% if exam_papers %}
                {% for paper in exam_papers %}
                    <p>Debug: Paper {{ paper.title }} has {{ paper.questions.count }} questions</p>
                    <div class="exam-paper" data-paper-id="{{ paper.id }}">
                        <div class="exam-header">
                            <h3 class="exam-title">ğŸ“ {{ paper.title }}</h3>
                            <div class="exam-info">
                                <p><strong>ç¸½åˆ†ï¼š</strong>{{ paper.total_points }} åˆ†</p>
                                <p><strong>é¡Œç›®æ•¸é‡ï¼š</strong>{{ paper.questions.count }} é¡Œ</p>
                            </div>
                        </div>
                        
                        <form method="post" action="{% url 'exam' %}" onsubmit="return confirmAction(event, this)">
                            {% csrf_token %}
                            <input type="hidden" name="paper_id" value="{{ paper.id }}">
                            
                            {% for question in paper.questions.all %}
                                <div class="question-container">
                                    <div class="question-header">
                                        <span class="question-number">ğŸ“Œ ç¬¬ {{ forloop.counter }} é¡Œ</span>
                                        <span class="question-points">{{ question.points }} åˆ†</span>
                                    </div>
                                    
                                    {% if question.title %}
                                        <div class="question-title">{{ question.title }}</div>
                                    {% endif %}
                                    
                                    <div class="question-content">{{ question.content|safe }}</div>
                                    
                                    {% if question.image %}
                                        <div class="question-image">
                                            <img src="{{ question.image.url }}" alt="é¡Œç›®åœ–ç‰‡">
                                        </div>
                                    {% endif %}
                                    
                                    {% if question.question_type == 'sc' %}
                                        {% if question.options and question.options|length > 0 %}
                                            <div class="options-container">
                                                {% for option in question.options %}
                                                    <div class="option-item">
                                                        <input type="radio" name="answers_{{ question.id }}" value="{{ forloop.counter0 }}" id="q{{ question.id }}_opt{{ forloop.counter0 }}" required>
                                                        <label for="q{{ question.id }}_opt{{ forloop.counter0 }}">{{ option|default:'ç„¡é¸é …' }}</label>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    {% elif question.question_type == 'mcq' %}
                                        {% if question.options and question.options|length > 0 %}
                                            <div class="options-container">
                                                {% for option in question.options %}
                                                    <div class="option-item">
                                                        <input type="checkbox" name="answers_{{ question.id }}" value="{{ forloop.counter0 }}" id="q{{ question.id }}_opt{{ forloop.counter0 }}">
                                                        <label for="q{{ question.id }}_opt{{ forloop.counter0 }}">{{ option|default:'ç„¡é¸é …' }}</label>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    {% elif question.question_type == 'tf' %}
                                        <div class="options-container">
                                            <div class="option-item">
                                                <input type="radio" name="answers_{{ question.id }}" value="true" id="q{{ question.id }}_true" required>
                                                <label for="q{{ question.id }}_true">âœ… æ­£ç¢º (True)</label>
                                            </div>
                                            <div class="option-item">
                                                <input type="radio" name="answers_{{ question.id }}" value="false" id="q{{ question.id }}_false" required>
                                                <label for="q{{ question.id }}_false">âŒ éŒ¯èª¤ (False)</label>
                                            </div>
                                        </div>
                                    {% elif question.question_type == 'sa' %}
                                        <div class="text-answer">
                                            <label for="answer_{{ question.id }}"><strong>è«‹è¼¸å…¥æ‚¨çš„ç­”æ¡ˆï¼š</strong></label>
                                            <textarea name="answers_{{ question.id }}" id="answer_{{ question.id }}" rows="6" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„è©³ç´°ç­”æ¡ˆ..."></textarea>
                                        </div>
                                    {% else %}
                                        <div class="text-answer">
                                            <label for="answer_{{ question.id }}"><strong>è«‹è¼¸å…¥æ‚¨çš„ç­”æ¡ˆï¼š</strong></label>
                                            <input type="text" name="answers_{{ question.id }}" id="answer_{{ question.id }}" placeholder="è«‹è¼¸å…¥ç­”æ¡ˆ...">
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                            
                            <div class="submit-section">
                                <button type="submit" class="submit-btn">ğŸ“¤ æäº¤è€ƒå·</button>
                                {% if user.is_staff %}
                                    <button type="submit" name="end_exam" value="1" class="submit-btn end-btn">ğŸ”š çµæŸè€ƒè©¦</button>
                                {% endif %}
                            </div>
                        </form>
                    </div>
                {% endfor %}
            {% else %}
                <div class="no-exam-message">
                    <h3>ğŸ“‹ ç›®å‰æ²’æœ‰å¯ç”¨çš„è€ƒè©¦</h3>
                    <p>è«‹è¯ç¹«ç®¡ç†å“¡æˆ–ç¨å¾Œå†è©¦</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- è…³æ³¨ -->
    <div class="footer">æœŸæœ«å°ˆæ¡ˆ Â© 2025</div>

    <script src="{% static 'js/exam.js' %}"></script>
</body>
</html>