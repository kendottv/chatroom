{% load static %}
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>è€ƒè©¦</title>
    {% load static %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'room/css/exam.css' %}">
</head>
<body>
    <!-- ç°¡å–®å°èˆªæ¬„ï¼ˆé»‘è‰²èƒŒæ™¯ï¼‰ -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'room:home' %}">é¦–é </a>
            <div class="navbar-nav">
                <a class="nav-link" href="{% url 'room:exam' %}">è€ƒè©¦</a>
            </div>
        </div>
    </nav>

    <!-- è³‡è¨Šæ¬„ -->
    <div class="info-bar container mt-3">
        <span>å­¸è™Ÿ: {{ user.student_id }}</span> | 
        <span>å§“å: {{ user.username }}</span> | 
        <span>ç­ç´š: {{ user.class_name }}</span>
    </div>

    <!-- è€ƒè©¦å®¹å™¨ -->
    <div class="exam-container">
        <!-- AI å•ç­”å€åŸŸï¼ˆå·¦å´ï¼‰ -->
        <div class="ai-section">
            <h3 class="ai-title">ğŸ¤– AI å•ç­”åŠ©æ‰‹</h3>
            <div class="ai-description">
                å¦‚æœæ‚¨åœ¨è€ƒè©¦éç¨‹ä¸­æœ‰ç–‘å•ï¼Œå¯ä»¥å‘ AI åŠ©æ‰‹æå•ç²å¾—å¹«åŠ©
                <p class="ai-limit">AI å•ç­”æ¬¡æ•¸é™åˆ¶ï¼š<span id="ai-limit-display">{{ ai_total_limit }} æ¬¡</span></p>
                <p class="ai-remaining">å‰©é¤˜æ¬¡æ•¸ï¼š<span id="ai-remaining-display" data-limit="{{ ai_remaining }}">{{ ai_remaining }} æ¬¡</span></p>
                <input type="hidden" id="current-paper-id" value="{{ exam_papers.0.id|default:'' }}">
            </div>
            <textarea id="ai_question" class="form-control mb-2 ai-input" placeholder="è«‹è¼¸å…¥æ‚¨çš„å•é¡Œï¼Œä¾‹å¦‚ï¼š&#10;â€¢ é€™é“é¡Œç›®çš„é—œéµæ¦‚å¿µæ˜¯ä»€éº¼ï¼Ÿ&#10;â€¢ æˆ‘æ‡‰è©²å¦‚ä½•ç†è§£é€™å€‹å•é¡Œï¼Ÿ&#10;â€¢ èƒ½å¦è§£é‡‹ä¸€ä¸‹ç›¸é—œçŸ¥è­˜é»ï¼Ÿ"></textarea>
            <button onclick="askAI()" class="btn btn-primary w-100 ai-btn" {% if ai_remaining <= 0 %}disabled{% endif %}>
                {% if ai_remaining <= 0 %}å·²é”ä¸Šé™{% else %}ğŸ’¬ å‘ AI æå•{% endif %}
            </button>
            <div id="ai-response" class="ai-response mt-3 p-2 border rounded">
                AI å›æ‡‰å°‡é¡¯ç¤ºåœ¨é€™è£¡...
                <br><br>
                ğŸ’¡ <strong>ä½¿ç”¨æç¤ºï¼š</strong>
                <ul style="margin: 10px 0; padding-left: 20px; font-size: 13px;">
                    <li>æå•è¦å…·é«”æ˜ç¢º</li>
                    <li>å¯ä»¥è©¢å•æ¦‚å¿µè§£é‡‹</li>
                    <li>å¯ä»¥è«‹æ±‚è§£é¡Œæ€è·¯</li>
                </ul>
            </div>
        </div>

        <!-- åˆ†éš”ç·š -->
        <div class="divider d-none d-md-block" style="width: 1px; background-color: #ddd;"></div>

        <!-- è€ƒå·å€åŸŸï¼ˆå³å´ï¼‰ -->
        <div class="exam-paper-section">
            <!-- é¡¯ç¤ºè¨Šæ¯ -->
            {% if messages %}
                <div class="messages">
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}

            {% if exam_papers %}
                {% for paper in exam_papers %}
                    <p class="text-muted">Debug: Paper {{ paper.title }} has {{ paper.questions.count }} questions, AI Limit: {{ paper.ai_total_limit }}</p>
                    <div class="exam-paper" data-paper-id="{{ paper.id }}">
                        <div class="exam-header">
                            <h3 class="exam-title">ğŸ“ {{ paper.title }}</h3>
                            <div class="exam-info">
                                <p><strong>ç¸½åˆ†ï¼š</strong>{{ paper.total_points }} åˆ†</p>
                                <p><strong>é¡Œç›®æ•¸é‡ï¼š</strong>{{ paper.questions.count }} é¡Œ</p>
                                <p><strong>AI å•ç­”æ¬¡æ•¸é™åˆ¶ï¼š</strong>{{ paper.ai_total_limit }} æ¬¡</p>
                            </div>
                        </div>
                        
                        <form method="post" action="{% url 'room:exam' %}" id="exam-form-{{ paper.id }}">
                            {% csrf_token %}
                            <input type="hidden" name="paper_id" value="{{ paper.id }}">
                            <input type="hidden" name="answers" id="answers-{{ paper.id }}">

                            <!-- é¡Œç›®åˆ‡æ›å€åŸŸ -->
                            <div class="question-nav mb-3">
                                <span id="current-question-{{ paper.id }}">ç¬¬ 1 é¡Œ / {{ paper.questions.count }} é¡Œ</span>
                                <button type="button" id="prev-question-{{ paper.id }}" class="btn btn-secondary nav-btn" disabled>ä¸Šä¸€é¡Œ</button>
                                <button type="button" id="next-question-{{ paper.id }}" class="btn btn-primary nav-btn">ä¸‹ä¸€é¡Œ</button>
                            </div>

                            {% for question in paper.questions_with_answers %}
                                <div class="question-container" data-question-id="{{ question.id }}" {% if forloop.first %}data-active="true"{% endif %}>
                                    <div class="question-header">
                                        <span class="question-number">ğŸ“Œ ç¬¬ {{ forloop.counter }} é¡Œ</span>
                                        <span autistic="question-points">{{ question.points }} åˆ†</span>
                                        <span class="question-ai-limit">AI é™åˆ¶: {% if question.ai_limit %}{{ question.ai_limit }}{% else %}ç„¡{% endif %} æ¬¡</span>
                                    </div>
                                    
                                    {% if question.title %}
                                        <div class="question-title">{{ question.title }}</div>
                                    {% endif %}
                                    
                                    <div class="question-content">{{ question.content|safe }}</div>
                                    
                                    {% if question.image %}
                                        <div class="question-image">
                                            <img src="{{ question.image.url }}" alt="é¡Œç›®åœ–ç‰‡" class="img-fluid">
                                        </div>
                                    {% endif %}
                                    
                                    {% if question.question_type == 'sc' %}
                                        {% if question.options and question.options|length > 0 %}
                                            <div class="options-container">
                                                {% for option in question.options %}
                                                    <div class="option-item form-check">
                                                        <input type="radio" name="answer-{{ question.id }}" value="{{ forloop.counter0 }}" id="q{{ question.id }}_opt{{ forloop.counter0 }}" class="form-check-input"
                                                            {% if question.student_answer == forloop.counter0|stringformat:"s" %}checked{% endif %}>
                                                        <label for="q{{ question.id }}_opt{{ forloop.counter0 }}" class="form-check-label">{% if option %}{{ option }}{% else %}ç„¡é¸é …{% endif %}</label>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    {% elif question.question_type == 'mcq' %}
                                        {% if question.options and question.options|length > 0 %}
                                            <div class="options-container">
                                                {% for option in question.options %}
                                                    <div class="option-item form-check">
                                                        <input type="checkbox" name="answer-{{ question.id }}[]" value="{{ forloop.counter0 }}" id="q{{ question.id }}_opt{{ forloop.counter0 }}" class="form-check-input"
                                                            {% if forloop.counter0|stringformat:"s" in question.student_answer_list %}checked{% endif %}>
                                                        <label for="q{{ question.id }}_opt{{ forloop.counter0 }}" class="form-check-label">{% if option %}{{ option }}{% else %}ç„¡é¸é …{% endif %}</label>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    {% elif question.question_type == 'tf' %}
                                        <div class="options-container">
                                            <div class="option-item form-check">
                                                <input type="radio" name="answer-{{ question.id }}" value="true" id="q{{ question.id }}_true" class="form-check-input"
                                                    {% if question.student_answer == 'true' %}checked{% endif %}>
                                                <label for="q{{ question.id }}_true" class="form-check-label">âœ… æ­£ç¢º (True)</label>
                                            </div>
                                            <div class="option-item form-check">
                                                <input type="radio" name="answer-{{ question.id }}" value="false" id="q{{ question.id }}_false" class="form-check-input"
                                                    {% if question.student_answer == 'false' %}checked{% endif %}>
                                                <label for="q{{ question.id }}_false" class="form-check-label">âŒ éŒ¯èª¤ (False)</label>
                                            </div>
                                        </div>
                                    {% elif question.question_type == 'sa' or question.question_type == 'essay' %}
                                        <div class="text-answer">
                                            <label for="answer-{{ question.id }}" class="form-label"><strong>è«‹è¼¸å…¥æ‚¨çš„ç­”æ¡ˆï¼š</strong></label>
                                            <textarea name="answer-{{ question.id }}" id="answer-{{ question.id }}" rows="6" class="form-control" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„è©³ç´°ç­”æ¡ˆ...">{{ question.student_answer }}</textarea>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                            
                            <div class="submit-section">
                                <button type="submit" class="btn btn-success submit-btn">ğŸ“¤ æäº¤è€ƒå·</button>
                                {% if user.is_staff %}
                                    <button type="submit" name="end_exam" value="1" class="btn btn-danger end-btn">ğŸ”š çµæŸè€ƒè©¦</button>
                                {% endif %}
                            </div>
                        </form>
                    </div>
                {% endfor %}
            {% else %}
                <div class="no-exam-message alert alert-info">
                    <h3>ğŸ“‹ ç›®å‰æ²’æœ‰å¯ç”¨çš„è€ƒè©¦</h3>
                    <p>è«‹è¯ç¹«ç®¡ç†å“¡æˆ–ç¨å¾Œå†è©¦</p>
                </div>
            {% endif %}
        </div>
    </div>


    <!-- å¼•å…¥ JavaScript -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'room/js/exam.js' %}"></script>
</body>
</html>