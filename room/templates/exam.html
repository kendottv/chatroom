<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>考試</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/exam.css' %}">
</head>
<body>
    <!-- 簡單導航欄 -->
    <nav>
        <div>
            <a href="/" style="margin-right: 20px;">首頁</a>
            <a href="/exam/" style="margin-right: 20px;">考試</a>
        </div>
    </nav>

    <!-- 資訊欄 -->
    <div class="info-bar">
        <span>學號: {{ user.student_id }}</span>
        <span>姓名: {{ user.username }}</span>
        <span>班級: {{ user.class_name }}</span>
    </div>

    <!-- 考試容器 -->
    <div class="exam-container">
        <!-- AI 問答區域（左側） -->
        <div class="ai-section">
            <h3 class="ai-title">🤖 AI 問答助手</h3>
            <div class="ai-description">
                如果您在考試過程中有疑問，可以向 AI 助手提問獲得幫助
            </div>
            <textarea id="ai_question" class="ai-input" placeholder="請輸入您的問題，例如：
• 這道題目的關鍵概念是什麼？
• 我應該如何理解這個問題？
• 能否解釋一下相關知識點？"></textarea>
            <button onclick="askAI()" class="ai-btn">💬 向 AI 提問</button>
            <div id="ai-response" class="ai-response">
                AI 回應將顯示在這裡...
                <br><br>
                💡 <strong>使用提示：</strong>
                <ul style="margin: 10px 0; padding-left: 20px; font-size: 13px;">
                    <li>提問要具體明確</li>
                    <li>可以詢問概念解釋</li>
                    <li>可以請求解題思路</li>
                </ul>
            </div>
        </div>

        <!-- 分隔線 -->
        <div class="divider"></div>

        <!-- 考卷區域（右側） -->
        <div class="exam-paper-section">
            <!-- 顯示訊息 -->
            {% if messages %}
                <div class="messages">
                    {% for message in messages %}
                        <p class="{{ message.tags }}">{{ message }}</p>
                    {% endfor %}
                </div>
            {% endif %}

            <!-- 除錯資訊 -->
            <p>Debug: exam_papers count = {{ exam_papers|length }}</p>
            {% if exam_papers %}
                {% for paper in exam_papers %}
                    <p>Debug: Paper {{ paper.title }} has {{ paper.questions.count }} questions</p>
                    <div class="exam-paper" data-paper-id="{{ paper.id }}">
                        <div class="exam-header">
                            <h3 class="exam-title">📝 {{ paper.title }}</h3>
                            <div class="exam-info">
                                <p><strong>總分：</strong>{{ paper.total_points }} 分</p>
                                <p><strong>題目數量：</strong>{{ paper.questions.count }} 題</p>
                            </div>
                        </div>
                        
                        <form method="post" action="{% url 'exam' %}" onsubmit="return confirmAction(event, this)">
                            {% csrf_token %}
                            <input type="hidden" name="paper_id" value="{{ paper.id }}">
                            
                            {% for question in paper.questions.all %}
                                <div class="question-container">
                                    <div class="question-header">
                                        <span class="question-number">📌 第 {{ forloop.counter }} 題</span>
                                        <span class="question-points">{{ question.points }} 分</span>
                                    </div>
                                    
                                    {% if question.title %}
                                        <div class="question-title">{{ question.title }}</div>
                                    {% endif %}
                                    
                                    <div class="question-content">{{ question.content|safe }}</div>
                                    
                                    {% if question.image %}
                                        <div class="question-image">
                                            <img src="{{ question.image.url }}" alt="題目圖片">
                                        </div>
                                    {% endif %}
                                    
                                    {% if question.question_type == 'sc' %}
                                        {% if question.options and question.options|length > 0 %}
                                            <div class="options-container">
                                                {% for option in question.options %}
                                                    <div class="option-item">
                                                        <input type="radio" name="answers_{{ question.id }}" value="{{ forloop.counter0 }}" id="q{{ question.id }}_opt{{ forloop.counter0 }}" required>
                                                        <label for="q{{ question.id }}_opt{{ forloop.counter0 }}">{{ option|default:'無選項' }}</label>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    {% elif question.question_type == 'mcq' %}
                                        {% if question.options and question.options|length > 0 %}
                                            <div class="options-container">
                                                {% for option in question.options %}
                                                    <div class="option-item">
                                                        <input type="checkbox" name="answers_{{ question.id }}" value="{{ forloop.counter0 }}" id="q{{ question.id }}_opt{{ forloop.counter0 }}">
                                                        <label for="q{{ question.id }}_opt{{ forloop.counter0 }}">{{ option|default:'無選項' }}</label>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    {% elif question.question_type == 'tf' %}
                                        <div class="options-container">
                                            <div class="option-item">
                                                <input type="radio" name="answers_{{ question.id }}" value="true" id="q{{ question.id }}_true" required>
                                                <label for="q{{ question.id }}_true">✅ 正確 (True)</label>
                                            </div>
                                            <div class="option-item">
                                                <input type="radio" name="answers_{{ question.id }}" value="false" id="q{{ question.id }}_false" required>
                                                <label for="q{{ question.id }}_false">❌ 錯誤 (False)</label>
                                            </div>
                                        </div>
                                    {% elif question.question_type == 'sa' %}
                                        <div class="text-answer">
                                            <label for="answer_{{ question.id }}"><strong>請輸入您的答案：</strong></label>
                                            <textarea name="answers_{{ question.id }}" id="answer_{{ question.id }}" rows="6" placeholder="請在此輸入您的詳細答案..."></textarea>
                                        </div>
                                    {% else %}
                                        <div class="text-answer">
                                            <label for="answer_{{ question.id }}"><strong>請輸入您的答案：</strong></label>
                                            <input type="text" name="answers_{{ question.id }}" id="answer_{{ question.id }}" placeholder="請輸入答案...">
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                            
                            <div class="submit-section">
                                <button type="submit" class="submit-btn">📤 提交考卷</button>
                                {% if user.is_staff %}
                                    <button type="submit" name="end_exam" value="1" class="submit-btn end-btn">🔚 結束考試</button>
                                {% endif %}
                            </div>
                        </form>
                    </div>
                {% endfor %}
            {% else %}
                <div class="no-exam-message">
                    <h3>📋 目前沒有可用的考試</h3>
                    <p>請聯繫管理員或稍後再試</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- 腳注 -->
    <div class="footer">期末專案 © 2025</div>

    <script src="{% static 'js/exam.js' %}"></script>
</body>
</html>